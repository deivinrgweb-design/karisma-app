<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Slot Machine Karisma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --karisma-black: #000000;
      --karisma-white: #ffffff;
      --karisma-turquoise: #00c9c8;
      --karisma-turquoise-dark: #00a3a2;
      --border-radius-main: 16px;
      --transition-fast: 0.2s ease-out;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, sans-serif;
    }
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      background: radial-gradient(circle at top, #071d1d, #000000 45%, #02070a);
      color: var(--karisma-white);
    }
    .app {
      position: relative;
      width: 100%;
      max-width: 420px;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 24px;
      padding: 20px 16px 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(0, 201, 200, 0.6);
      backdrop-filter: blur(8px);
      overflow: hidden;
    }

    .app-logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }

    .app-logo {
      width: 90px;
      max-width: 30vw;
      filter: drop-shadow(0 0 10px rgba(0, 201, 200, 0.5));
      animation: logoFloat 3s ease-in-out infinite;
    }

    .app-logo:hover {
      filter: drop-shadow(0 0 18px rgba(0, 201, 200, 0.9));
    }

    @keyframes logoFloat {
      0% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0); }
    }

    .app-title {
      font-size: 1.6rem;
      text-align: center;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .app-title span { color: var(--karisma-turquoise); }

    /* FORM TELEFONO */
    #phoneForm {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 10px;
    }
    #phoneForm input {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--karisma-turquoise);
      font-size: 1rem;
      outline: none;
    }
    #phoneForm button {
      padding: 12px;
      background: var(--karisma-turquoise);
      border: none;
      border-radius: 12px;
      color: black;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    #phoneForm button:hover {
      filter: brightness(1.1);
    }

    #slotSection {
      display: none;
    }

    /* Slot machine stili */
    .slot-machine {
      margin: 20px 0;
      padding: 14px;
      background: linear-gradient(145deg, #ffffff, #eef9f8);
      border-radius: var(--border-radius-main);
      border: 2px solid var(--karisma-turquoise);
    }
    .slot-window {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .reel {
      flex: 1;
      aspect-ratio: 3/4;
      background: linear-gradient(180deg, #fdfefe, #ecf4f5);
      border-radius: 12px;
      border: 2px solid #d7e1e3;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      transition: box-shadow var(--transition-fast);
    }
    .symbol {
      font-size: 2.4rem;
      transition: transform var(--transition-fast);
    }
    .reel.spinning .symbol {
      animation: spinAnim 0.15s linear infinite;
    }
    @keyframes spinAnim {
      0% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0); }
    }

    .reel.spinning {
      box-shadow: 0 0 14px rgba(0, 201, 200, 0.7);
    }

    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    #spinButton {
      width: 100%;
      max-width: 260px;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      background: linear-gradient(135deg, var(--karisma-turquoise), var(--karisma-turquoise-dark));
      color: black;
      cursor: pointer;
      border: none;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }
    #spinButton:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    #spinButton:hover:not(:disabled) {
      transform: translateY(-1px);
    }

    .tries-info {
      font-size: 0.8rem;
      opacity: 0.8;
      text-align: center;
    }

    .result {
      margin-top: 18px;
      padding: 12px 10px;
      border-radius: 14px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid rgba(0, 201, 200, 0.4);
      text-align: center;
      transform: translateY(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
    }

    .result.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .result-message {
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .result-message span {
      color: var(--karisma-turquoise);
      font-weight: 600;
    }

    .result-coupon {
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0, 201, 200, 0.08);
      border: 1px dashed rgba(0, 201, 200, 0.5);
      display: inline-block;
      margin-top: 4px;
    }

    .result-coupon-code {
      font-weight: 700;
      color: var(--karisma-turquoise);
    }

    /* Confetti */
    #confettiContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 5;
    }

    .confetti-piece {
      position: absolute;
      width: 6px;
      height: 14px;
      border-radius: 2px;
      background: var(--karisma-turquoise);
      opacity: 0.9;
      animation: confettiFall 1.6s linear forwards;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(-20px) rotate(0deg);
      }
      100% {
        transform: translateY(120vh) rotate(360deg);
        opacity: 0;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="confettiContainer"></div>

    <div class="app-logo-wrap">
      <img
        src="https://cdn.shopify.com/s/files/1/0825/8332/2948/files/Frame_39915080.png?v=1764011327"
        alt="Karisma Logo"
        class="app-logo"
      />
    </div>

    <h1 class="app-title">Slot <span>Karisma</span></h1>

    <form id="phoneForm">
      <p style="text-align:center; opacity:0.8;">Inserisci il tuo numero per giocare e ricevere il premio</p>
      <input type="tel" id="phoneInput" placeholder="Es. 333 1234567" required>
      <button type="submit">Conferma e Gioca</button>
      <p id="phoneError" style="color:#ff6b6b; text-align:center; display:none;">Inserisci un numero valido</p>
    </form>

    <div id="slotSection">
      <p style="text-align:center; margin-top:10px; opacity:0.85;">Premi GIRA per scoprire il tuo premio Karisma</p>

      <section class="slot-machine">
        <div class="slot-window">
          <div class="reel"><span class="symbol">üçí</span></div>
          <div class="reel"><span class="symbol">‚≠ê</span></div>
          <div class="reel"><span class="symbol">üçã</span></div>
        </div>
      </section>

      <section class="controls">
        <button id="spinButton">Gira</button>
        <p id="triesInfo" class="tries-info">Hai 3 tentativi disponibili.</p>
      </section>

      <section id="result" class="result">
        <p class="result-message"></p>
        <p class="result-coupon">
          Codice sconto: <span class="result-coupon-code"></span>
        </p>
        <p class="result-note" style="font-size:0.7rem; opacity:0.7; margin-top:4px;">
          Mostra questo codice in cassa o inseriscilo al checkout.
        </p>
      </section>
    </div>
  </div>

  <script>
    // üîó URL della tua Web App di Apps Script
    const SCRIPT_ = "https://script.google.com/macros/s/AKfycbzi5RChdafoR4bnnqLL0tryecmc2dnpX-xbKOuBTV31SrbNHBjDMA8XiVGUjSAzKely/exec";

    const phoneForm = document.getElementById("phoneForm");
    const phoneInput = document.getElementById("phoneInput");
    const phoneError = document.getElementById("phoneError");
    const slotSection = document.getElementById("slotSection");

    const spinButton = document.getElementById("spinButton");
    const resultBox = document.getElementById("result");
    const resultMessageEl = document.querySelector(".result-message");
    const resultCouponCodeEl = document.querySelector(".result-coupon-code");
    const resultCouponEl = document.querySelector(".result-coupon");
    const reels = document.querySelectorAll(".reel");
    const confettiContainer = document.getElementById("confettiContainer");
    const triesInfo = document.getElementById("triesInfo");

    // ----------- INVIO TELEFONO ----------
    phoneForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const phone = phoneInput.value.trim();
      if (phone.length < 5) {
        phoneError.style.display = "block";
        return;
      }
      phoneError.style.display = "none";

      const btn = phoneForm.querySelector("button");
      btn.disabled = true;
      btn.textContent = "Caricamento...";

      const formData = new FormData();
      formData.append("phone", phone);

      fetch(SCRIPT_, {
        method: "POST",
        mode: "no-cors",
        body: formData
      }).catch(() => {
        // anche se va in errore di rete non blocchiamo il gioco
      });

      // mostra subito la slot
      phoneForm.style.display = "none";
      slotSection.style.display = "block";
    });

    // ----------- SLOT MACHINE -----------
    const SYMBOLS = [
      { name: "Logo Karisma (gadget esclusivo)", icon: "üåÄ" },
      { name: "Pallone da calcio Karisma", icon: "‚öΩÔ∏è" },
      { name: "Scarpe sport Karisma", icon: "üëü" },
      { name: "Sconto 10%", icon: "üí∏" },
      { name: "Calzettoni tecnici", icon: "üß¶" },
      { name: "Mystery Box Karisma", icon: "üéÅ" }
    ];

    const COUPON_CODES = [
      "KARISMA10",
      "KARISMA-SPORT",
      "KARISMA-TEAM",
      "WIN-KARISMA",
      "KARISMA2025"
    ];

    let spinning = false;
    let spinIntervals = [];

    // üî¢ Limite tentativi + vincita garantita entro 3 spin
    const MAX_SPINS = 3;
    let spinsDone = 0;
    let hasWon = false;

    function updateTriesInfo() {
      if (hasWon) {
        triesInfo.textContent = "Hai vinto! Non hai pi√π bisogno di altri tentativi üòÑ";
      } else if (spinsDone >= MAX_SPINS) {
        triesInfo.textContent = "Hai usato tutti i tuoi " + MAX_SPINS + " tentativi.";
      } else if (spinsDone === 0) {
        triesInfo.textContent = "Hai " + MAX_SPINS + " tentativi disponibili.";
      } else {
        triesInfo.textContent = "Tentativo " + spinsDone + " di " + MAX_SPINS + ".";
      }
    }

    updateTriesInfo();

    function launchConfetti() {
      if (!confettiContainer) return;

      const confettiCount = 40;

      for (let i = 0; i < confettiCount; i++) {
        const confetto = document.createElement("div");
        confetto.classList.add("confetti-piece");

        const left = Math.random() * 100; // %
        const delay = Math.random() * 0.4; // s
        const duration = 1.2 + Math.random() * 0.7; // s

        confetto.style.left = left + "%";
        confetto.style.animationDelay = delay + "s";
        confetto.style.animationDuration = duration + "s";

        const rand = Math.random();
        if (rand < 0.33) {
          confetto.style.background = "#00c9c8";
        } else if (rand < 0.66) {
          confetto.style.background = "#ffffff";
        } else {
          confetto.style.background = "#00a3a2";
        }

        confettiContainer.appendChild(confetto);

        setTimeout(() => {
          confetto.remove();
        }, (delay + duration) * 1000);
      }
    }

    spinButton.addEventListener("click", () => {
      if (spinning) return;

      // Se ha gi√† vinto o ha esaurito i tentativi, blocca
      if (hasWon || spinsDone >= MAX_SPINS) {
        alert("Hai gi√† utilizzato i tuoi 3 tentativi.");
        return;
      }

      spinsDone++;
      updateTriesInfo();
      spinning = true;

      resultBox.classList.remove("visible");
      spinIntervals = [];

      reels.forEach(reel => {
        reel.classList.add("spinning");
        const symbolSpan = reel.querySelector(".symbol");

        const interval = setInterval(() => {
          const randomSymbol = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
          symbolSpan.textContent = randomSymbol.icon;
        }, 80);

        spinIntervals.push(interval);
      });

      const winner = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
      const coupon = COUPON_CODES[Math.floor(Math.random() * COUPON_CODES.length)];

      setTimeout(() => {
        spinIntervals.forEach(clearInterval);
        spinIntervals = [];

        reels.forEach(reel => {
          reel.classList.remove("spinning");
          reel.querySelector(".symbol").textContent = winner.icon;
        });

        let isWin = false;

        if (!hasWon) {
          if (spinsDone === MAX_SPINS) {
            isWin = true; // 3¬∞ tentativo = win garantita se non ha ancora vinto
          } else {
            isWin = Math.random() < 0.4; // probabilit√† di win prima del 3¬∞
          }
        }

        if (isWin) {
          hasWon = true;
          resultMessageEl.innerHTML = "Hai vinto: <span>" + winner.name + "</span>";
          resultCouponCodeEl.textContent = coupon;
          resultCouponEl.style.display = "inline-block";

          spinButton.disabled = true;
          spinButton.textContent = "Hai vinto!";
          updateTriesInfo();
          launchConfetti();
        } else {
          resultMessageEl.textContent = "Questa volta nessun premio, ritenta! (" + spinsDone + "/" + MAX_SPINS + ")";
          resultCouponEl.style.display = "none";

          if (spinsDone >= MAX_SPINS) {
            spinButton.disabled = true;
            spinButton.textContent = "Fine tentativi";
            updateTriesInfo();
          }
        }

        resultBox.classList.add("visible");
        spinning = false;
      }, 1500);
    });
  </script>
</body>
</html>
