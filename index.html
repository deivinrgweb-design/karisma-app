<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzSgfUt16y8BM2S_U4Y8rS0YcPbihEeJQrWxP0s8Sym6Hp11_K-6j7iN-VsFOX9T0DoNg/exec";

const phoneForm = document.getElementById("phoneForm");
const phoneInput = document.getElementById("phoneInput");
const phoneError = document.getElementById("phoneError");
const slotSection = document.getElementById("slotSection");

const spinButton = document.getElementById("spinButton");
const resultBox = document.getElementById("result");
const resultMessageEl = document.querySelector(".result-message");
const resultCouponCodeEl = document.querySelector(".result-coupon-code");
const reels = document.querySelectorAll(".reel");

// ----------- LOADING SUL FORM ----------
phoneForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const phone = phoneInput.value.trim();
  if (phone.length < 5) {
    phoneError.style.display = "block";
    return;
  }
  phoneError.style.display = "none";

  // loading visivo
  const btn = phoneForm.querySelector("button");
  btn.disabled = true;
  btn.textContent = "Caricamento...";

  await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone })
  });

  // vai alla slot
  phoneForm.style.display = "none";
  slotSection.style.display = "block";
});

// ----------- SLOT MACHINE -----------
const SYMBOLS = [
  { name: "Logo Karisma (gadget esclusivo)", icon: "ðŸŒ€" },
  { name: "Pallone da calcio Karisma", icon: "âš½ï¸" },
  { name: "Scarpe sport Karisma", icon: "ðŸ‘Ÿ" },
  { name: "Sconto 10%", icon: "ðŸ’¸" },
  { name: "Calzettoni tecnici", icon: "ðŸ§¦" },
  { name: "Mystery Box Karisma", icon: "ðŸŽ" }
];

const COUPON_CODES = ["KARISMA10", "KARISMA-SPORT", "KARISMA-TEAM", "WIN-KARISMA", "KARISMA2025"];

let spinning = false;
let spinIntervals = [];

spinButton.addEventListener("click", () => {
  if (spinning) return;   // <-- FIX
  spinning = true;

  resultBox.classList.remove("visible");
  spinIntervals = [];     // <-- RESET sicuro

  // avvia animazione rulli
  reels.forEach(reel => {
    reel.classList.add("spinning");

    const symbolSpan = reel.querySelector(".symbol");

    const interval = setInterval(() => {
      const randomSymbol = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
      symbolSpan.textContent = randomSymbol.icon;
    }, 80);

    spinIntervals.push(interval);
  });

  const winner = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
  const coupon = COUPON_CODES[Math.floor(Math.random()*COUPON_CODES.length)];

  setTimeout(() => {
    // stop rulli
    spinIntervals.forEach(clearInterval);
    spinIntervals = [];

    reels.forEach(reel => {
      reel.classList.remove("spinning");
      reel.querySelector(".symbol").textContent = winner.icon;
    });

    resultMessageEl.innerHTML = "Hai vinto: <span>" + winner.name + "</span>";
    resultCouponCodeEl.textContent = coupon;
    resultBox.classList.add("visible");

    spinning = false;  // <-- permette di rigirare
  }, 1500);
});
</script>
